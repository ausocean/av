<!DOCTYPE html>
<html>
<head>
    <title>Dual Pi Sync</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: #ddd; margin:0; padding: 20px; }

        .cam-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .cam-box { width: 45%; min-width: 400px; background: #333; padding: 10px; border-radius: 8px; }
        img { width: 100%; border: 2px solid #555; border-radius: 4px; }

        /* Settings Box */
        .settings-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .settings-box { background: #333; padding: 15px; border-radius: 8px; text-align: left; min-width: 320px; }
        .settings-box h3 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .settings-row { margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .settings-row label { width: 100px; color: #aaa; }
        input[type=range] { flex-grow: 1; margin: 0 10px; cursor: pointer; }
        select, button { padding: 6px; border-radius: 4px; border: none; cursor: pointer; }

        /* Main Controls */
        .controls { margin: 30px 0; padding: 20px; background: #2a2a2a; border-radius: 10px; display: inline-block; }
        .main-btn { padding: 15px 30px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; margin: 0 10px; font-weight: bold; }
        #btn-photo { background: #007bff; color: white; }
        #btn-start { background: #28a745; color: white; }
        #btn-stop { background: #dc3545; color: white; display: none; }

        /* Gallery */
        .gallery-section { display: flex; gap: 20px; justify-content: center; margin-top: 40px; text-align: left; }
        .gallery-col { width: 45%; background: #2a2a2a; padding: 15px; border-radius: 8px; }
        .file-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #444; }
        .btn-dl { background: #444; color: white; padding: 3px 8px; text-decoration:none; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body onload="loadAllGalleries(); initControls();">
    <h1>Synchronized Capture System</h1>

    <div class="cam-container">
        <div class="cam-box">
            <h2>Left</h2>
            <img src="/video_feed" />
        </div>
        <div class="cam-box">
            <h2>Right</h2>
            <img src="http://{{ right_ip }}:5000/video_feed" />
        </div>
    </div>

    <div class="settings-container">
        <div class="settings-box">
            <h3>Image Settings</h3>
            <div class="settings-row">
                <label>Resolution:</label>
                <select id="res-select" onchange="changeResolution()">
                    <option value="1280,720">720p</option>
                    <option value="1920,1080" selected>1080p</option>
                </select>
            </div>
            <div class="settings-row">
                <label>Exposure:</label>
                <input type="range" id="exp-slider" min="100" max="30000" step="100" value="10000" oninput="updateControls()">
                <span id="exp-val" style="width: 50px; text-align: right;">Auto</span>
            </div>
             <div class="settings-row" style="justify-content: flex-end;">
                <button onclick="setAutoExposure()" style="background: #444; color: white;">Reset Auto Exp</button>
            </div>
             <div class="settings-row">
                <label>Framerate:</label>
                <input type="number" id="fps-input" value="24" min="1" max="60" style="width: 50px;" onchange="updateControls()">
            </div>
        </div>

        <div class="settings-box">
            <h3>Focus Control</h3>
            <div class="settings-row">
                <label>Mode:</label>
                <select id="af-mode" onchange="changeFocusMode()">
                    <option value="2" selected>Continuous (CAF)</option>
                    <option value="1">Auto (One-Shot)</option>
                    <option value="0">Manual</option>
                </select>
            </div>

            <div class="settings-row" id="manual-focus-row" style="opacity: 0.5; pointer-events: none;">
                <label>Position:</label>
                <input type="range" id="focus-slider" min="0" max="15" step="0.1" value="0" oninput="updateFocus()">
                <span id="focus-val" style="width: 30px;">Inf</span>
            </div>

            <div class="settings-row" id="auto-focus-row" style="display: none;">
                <button onclick="triggerAutofocus()" style="width: 100%; background: #007bff; color: white; padding: 10px;">Trigger Autofocus Now</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="btn-photo" class="main-btn" onclick="takePhoto()">Take Photo (Sync)</button>
        <button id="btn-start" class="main-btn" onclick="toggleRecord(true)">Start Video (Sync)</button>
        <button id="btn-stop" class="main-btn" onclick="toggleRecord(false)">Stop Video</button>
        <div id="status" style="margin-top: 15px; color: #aaa;">Ready</div>
    </div>

    <div class="gallery-section">
        <div class="gallery-col">
            <h2>Left Files</h2>
            <div id="gallery-left">Loading...</div>
        </div>
        <div class="gallery-col">
            <h2>Right Files</h2>
            <div id="gallery-right">Loading...</div>
        </div>
    </div>

    <script>
        const RIGHT_API = "http://{{ right_ip }}:5000";

        function initControls() {
            // Set initial UI state
            changeFocusMode();
        }

        // --- Focus Logic ---
        function changeFocusMode() {
            const mode = parseInt(document.getElementById('af-mode').value);
            const manualRow = document.getElementById('manual-focus-row');
            const autoRow = document.getElementById('auto-focus-row');

            if (mode === 0) { // Manual
                manualRow.style.opacity = "1";
                manualRow.style.pointerEvents = "auto";
                autoRow.style.display = "none";
            } else if (mode === 1) { // Auto One-Shot
                manualRow.style.opacity = "0.5";
                manualRow.style.pointerEvents = "none";
                autoRow.style.display = "flex";
            } else { // Continuous
                manualRow.style.opacity = "0.5";
                manualRow.style.pointerEvents = "none";
                autoRow.style.display = "none";
            }

            // Send command
            fetch('/set_controls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ af_mode: mode })
            });
        }

        function updateFocus() {
            const val = document.getElementById('focus-slider').value;
            document.getElementById('focus-val').innerText = val;
            fetch('/set_controls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ af_mode: 0, lens_position: val })
            });
        }

        function triggerAutofocus() {
            fetch('/set_controls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ af_mode: 1, af_trigger: true })
            });
        }

        // --- Exposure & Image Logic ---
        function updateControls() {
            const exposure = document.getElementById('exp-slider').value;
            const fps = document.getElementById('fps-input').value;

            document.getElementById('exp-val').innerText = exposure;

            fetch('/set_controls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ exposure: exposure, framerate: fps })
            });
        }

        function setAutoExposure() {
            document.getElementById('exp-val').innerText = "Auto";
            fetch('/set_controls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ auto_exposure: true })
            });
        }

        function changeResolution() {
            const val = document.getElementById('res-select').value.split(',');
            if(!confirm("Cameras will briefly restart. Continue?")) return;

            fetch('/set_resolution', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ width: parseInt(val[0]), height: parseInt(val[1]) })
            }).then(() => setTimeout(() => location.reload(), 3000));
        }

        // --- Capture Logic ---
        function takePhoto() {
            document.getElementById('status').innerText = "Syncing & Capturing...";
            fetch('/capture_sync_photo', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('status').innerText = "Photo Saved: " + data.filename;
                        setTimeout(loadAllGalleries, 1000);
                    } else alert(data.message);
                });
        }

        function toggleRecord(start) {
            const endpoint = start ? '/start_sync_record' : '/stop_sync_record';
            document.getElementById('status').innerText = "Syncing...";
            fetch(endpoint, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('btn-start').style.display = start ? 'none' : 'inline-block';
                        document.getElementById('btn-stop').style.display = start ? 'inline-block' : 'none';
                        document.getElementById('status').innerText = start ? "Recording..." : "Stopped.";
                        if(!start) setTimeout(loadAllGalleries, 1000);
                    } else alert(data.message);
                });
        }

        // --- Gallery ---
        function loadAllGalleries() {
            loadGallery('/list_recordings', 'gallery-left', '');
            loadGallery(RIGHT_API + '/list_recordings', 'gallery-right', RIGHT_API);
        }

        function loadGallery(url, elementId, baseUrl) {
            fetch(url).then(res => res.json()).then(files => {
                const container = document.getElementById(elementId);
                container.innerHTML = '';
                if(files.length === 0) container.innerHTML = '<div style="color:#666">Empty</div>';

                files.forEach(f => {
                    const dl = baseUrl ? baseUrl + '/recordings/' + f : '/recordings/' + f;
                    const d = document.createElement('div');
                    d.className = 'file-item';
                    d.innerHTML = `<span>${f}</span><a href="${dl}" class="btn-dl" download>Download</a>`;
                    container.appendChild(d);
                });
            }).catch(() => document.getElementById(elementId).innerText = "Offline");
        }
    </script>
</body>
</html>
